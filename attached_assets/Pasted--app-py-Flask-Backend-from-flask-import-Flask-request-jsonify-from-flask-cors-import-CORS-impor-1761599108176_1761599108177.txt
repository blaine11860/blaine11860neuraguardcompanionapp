# app.py - Flask Backend
from flask import Flask, request, jsonify
from flask_cors import CORS
import numpy as np
import pandas as pd
from datetime import datetime
import json
import logging
from dataclasses import dataclass
from typing import Dict, List, Optional

app = Flask(__name__)
CORS(app)

@dataclass
class PatientData:
    plet_variation: float
    microvascular_flow: float
    optic_nerve_diameter: float
    bis_index: float
    spo2: float
    map_bp: float  # Mean Arterial Pressure
    hb: float
    temperature: float
    emboli_count: int
    timestamp: datetime

class OpticRiskScoreCalculator:
    def __init__(self):
        self.weights = {
            'microvascular_flow': 0.25,
            'plet_variation': 0.20,
            'emboli_count': 0.15,
            'optic_nerve_diameter': 0.15,
            'map_bp': 0.10,
            'hb': 0.10,
            'bis_index': 0.05
        }
        
        self.thresholds = {
            'microvascular_flow_critical': 15,  # mm/s
            'plet_variation_critical': 25,  # %
            'emboli_count_critical': 10,  # counts/min
            'onsd_critical': 5.7,  # mm
            'map_critical': 55,  # mmHg
            'hb_critical': 7.5  # g/dL
        }
    
    def calculate_cmro2_do2_ratio(self, data: PatientData) -> float:
        """Calculate cerebral metabolic rate vs oxygen delivery ratio"""
        # Simplified neurovascular coupling model
        cmro2 = data.bis_index * 0.3  # Metabolic demand related to anesthesia depth
        do2 = (data.hb * 1.34 * data.spo2 / 100) * data.microvascular_flow
        return cmro2 / do2 if do2 > 0 else 1.0
    
    def calculate_ors(self, data: PatientData) -> Dict:
        """Calculate comprehensive Optic Risk Score (0-100)"""
        try:
            # Normalize parameters (0-1, where 1 is worst)
            flow_score = max(0, 1 - (data.microvascular_flow / 30))
            plet_score = min(1, data.plet_variation / 40)
            emboli_score = min(1, data.emboli_count / 20)
            onsd_score = min(1, max(0, (data.optic_nerve_diameter - 4.5) / 2))
            map_score = max(0, 1 - (data.map_bp / 80))
            hb_score = max(0, 1 - (data.hb / 10))
            
            # Calculate individual component scores
            component_scores = {
                'microvascular_flow': flow_score * 100,
                'plet_variation': plet_score * 100,
                'emboli_count': emboli_score * 100,
                'optic_nerve_diameter': onsd_score * 100,
                'map_bp': map_score * 100,
                'hb': hb_score * 100
            }
            
            # Weighted overall score
            weighted_score = (
                flow_score * self.weights['microvascular_flow'] +
                plet_score * self.weights['plet_variation'] +
                emboli_score * self.weights['emboli_count'] +
                onsd_score * self.weights['optic_nerve_diameter'] +
                map_score * self.weights['map_bp'] +
                hb_score * self.weights['hb']
            )
            
            ors = weighted_score * 100
            cmro2_do2 = self.calculate_cmro2_do2_ratio(data)
            
            # Determine risk level
            if ors < 30:
                risk_level = "LOW"
                alert = False
            elif ors < 60:
                risk_level = "MODERATE" 
                alert = False
            else:
                risk_level = "HIGH"
                alert = True
            
            return {
                'ors_score': round(ors, 1),
                'risk_level': risk_level,
                'alert': alert,
                'component_scores': component_scores,
                'cmro2_do2_ratio': round(cmro2_do2, 3),
                'timestamp': data.timestamp.isoformat()
            }
            
        except Exception as e:
            logging.error(f"ORS calculation error: {e}")
            return {'error': str(e)}

class ConflictResolutionEngine:
    def detect_conflicts(self, data: PatientData, ors_result: Dict) -> List[Dict]:
        """Detect conflicting monitoring data"""
        conflicts = []
        
        # Conflict 1: Normal BIS but poor perfusion
        if data.bis_index > 60 and ors_result['component_scores']['microvascular_flow'] > 70:
            conflicts.append({
                'type': 'NEUROVASCULAR_DECOUPLING',
                'message': 'Adequate anesthesia depth but poor optic nerve perfusion',
                'severity': 'HIGH',
                'suggestions': [
                    'Check head positioning',
                    'Verify ultrasound probe placement',
                    'Consider MAP optimization'
                ]
            })
        
        # Conflict 2: Good SpO2 but microvascular compromise
        if data.spo2 > 95 and ors_result['component_scores']['microvascular_flow'] > 60:
            conflicts.append({
                'type': 'MICROVASCULAR_COMPROMISE',
                'message': 'Adequate systemic oxygenation but impaired local perfusion',
                'severity': 'MEDIUM',
                'suggestions': [
                    'Assess for venous congestion',
                    'Check intraocular pressure',
                    'Review positioning'
                ]
            })
        
        return conflicts

# Initialize engines
ors_calculator = OpticRiskScoreCalculator()
conflict_engine = ConflictResolutionEngine()

@app.route('/api/calculate-ors', methods=['POST'])
def calculate_ors():
    """Main endpoint for ORS calculation"""
    try:
        data = request.json
        patient_data = PatientData(
            plet_variation=float(data['plet_variation']),
            microvascular_flow=float(data['microvascular_flow']),
            optic_nerve_diameter=float(data['optic_nerve_diameter']),
            bis_index=float(data['bis_index']),
            spo2=float(data['spo2']),
            map_bp=float(data['map_bp']),
            hb=float(data['hb']),
            temperature=float(data['temperature']),
            emboli_count=int(data['emboli_count']),
            timestamp=datetime.now()
        )
        
        # Calculate ORS
        ors_result = ors_calculator.calculate_ors(patient_data)
        
        # Check for conflicts
        conflicts = conflict_engine.detect_conflicts(patient_data, ors_result)
        ors_result['conflicts'] = conflicts
        
        # Log for research
        log_research_data(patient_data, ors_result)
        
        return jsonify(ors_result)
        
    except Exception as e:
        return jsonify({'error': str(e)}), 400

@app.route('/api/research/cases', methods=['GET'])
def get_research_cases():
    """Get de-identified cases for research collaboration"""
    # In production, this would query a database
    return jsonify({
        'total_cases': 150,
        'recent_cases': get_recent_cases(),
        'collaborators': ['Mass Eye and Ear', 'Schepens Research']
    })

def log_research_data(patient_data: PatientData, ors_result: Dict):
    """Log de-identified data for research purposes"""
    research_log = {
        'timestamp': datetime.now().isoformat(),
        'ors_score': ors_result['ors_score'],
        'risk_level': ors_result['risk_level'],
        'physio_parameters': {
            'plet_variation': patient_data.plet_variation,
            'microvascular_flow': patient_data.microvascular_flow,
            'optic_nerve_diameter': patient_data.optic_nerve_diameter
        },
        'conflicts_detected': len(ors_result['conflicts'])
    }
    # In production, would save to database
    logging.info(f"Research data: {research_log}")

def get_recent_cases():
    """Mock recent cases for research portal"""
    return [
        {'case_id': 'CASE_001', 'ors_peak': 72.4, 'outcome': 'POVL_avoided', 'tags': ['emboli', 'hypotension']},
        {'case_id': 'CASE_002', 'ors_peak': 45.2, 'outcome': 'stable', 'tags': ['prolonged_prone']}
    ]

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000, debug=True)